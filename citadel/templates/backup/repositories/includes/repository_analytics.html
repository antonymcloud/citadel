<style>
    .chart-container {
        margin-bottom: 1rem;
        border-radius: 0.25rem;
        padding: 1rem;
        text-align: center;
        max-width: 100%;
        /* Use min-height instead of height: 100% */
        min-height: 350px;
        /* Cap the maximum height to prevent infinite expansion */
        max-height: 500px;
        overflow: auto; /* Changed from hidden to auto to allow scrolling if needed */
    }

    .progress-label {
        position: absolute;
        right: 15px;
        font-weight: bold;
    }

    .forecast-label {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .chart-wrapper {
        width: 100%;
        /* Set fixed height */
        height: 300px;
        position: relative;
        overflow: hidden;
    }
    
    /* Ensure canvas elements maintain proper sizing */
    canvas {
        max-width: 100%;
        max-height: 100%;
    }
</style>

<div class="card shadow mt-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Repository Analytics</h5>
    </div>
    <div class="card-body">
        <div id="analytics-loading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p>Loading repository analytics...</p>
        </div>
        <div id="analytics-content" class="d-none">
            <!-- Repository Statistics Overview -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="text-muted">Current Size</h6>
                            <h3 id="latest-size">-</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="text-muted">Space Usage</h6>
                            <h3 id="space-usage">-</h3>
                            <div class="progress">
                                <div class="progress-bar" id="usage-bar" role="progressbar" style="width: 0%;"
                                    aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="text-muted">Max Size</h6>
                            <h3 id="max-size">{{ repo.max_size }} GB</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="text-muted">Archives</h6>
                            <h3 id="archives-count">-</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Repository Growth and Backup Statistics -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Repository Growth</h6>
                        </div>
                        <div class="card-body chart-container">
                            <div class="chart-wrapper" id="growth-chart-container">
                                <canvas id="growth-chart"></canvas>
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p>Loading growth chart...</p>
                                </div>
                            </div>
                            <div class="alert alert-info text-center d-none" id="growth-chart-no-data">
                                <i class="fas fa-info-circle me-2"></i>Not enough data available to show growth chart
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Backup Statistics</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <tr>
                                    <th>Total Backups:</th>
                                    <td id="total-backups">-</td>
                                </tr>
                                <tr>
                                    <th>Successful Backups:</th>
                                    <td id="successful-backups">-</td>
                                </tr>
                                <tr>
                                    <th>Failed Backups:</th>
                                    <td id="failed-backups">-</td>
                                </tr>
                                <tr>
                                    <th>Success Rate:</th>
                                    <td id="success-rate">-</td>
                                </tr>
                                <tr>
                                    <th>Average Size:</th>
                                    <td id="average-size">-</td>
                                </tr>
                                <tr>
                                    <th>Average Compression:</th>
                                    <td id="average-compression">-</td>
                                </tr>
                                <tr>
                                    <th>Last Backup:</th>
                                    <td id="last-backup">-</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Second row for additional charts -->
            <div class="row">
                <!-- Backup Frequency Chart -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Backup Frequency</h6>
                        </div>
                        <div class="card-body chart-container">
                            <div id="day-frequency-chart-wrapper" class="chart-wrapper">
                                <canvas id="day-frequency-chart"></canvas>
                            </div>

                            <div class="alert alert-info text-center d-none" id="frequency-chart-no-data">
                                <i class="fas fa-info-circle me-2"></i>Not enough data available to show frequency chart
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Backup Success Rate Chart -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Success Rate</h6>
                        </div>
                        <div class="card-body chart-container">
                            <div class="chart-wrapper" id="success-chart-container">
                                <canvas id="success-rate-chart"></canvas>
                            </div>
                            <div class="alert alert-info text-center d-none" id="success-chart-no-data">
                                <i class="fas fa-info-circle me-2"></i>Not enough data available to show success rate
                                chart
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Forecast Section -->
            <div class="row mt-4" id="forecast-section">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-crystal-ball me-2"></i>Storage Forecast</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="alert alert-info">
                                        <h6>Estimated Growth Rate</h6>
                                        <h4 id="growth-rate-value">-</h4>
                                        <small class="forecast-label">Based on historical data</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="alert alert-warning">
                                        <h6>Estimated Full Date</h6>
                                        <h4 id="full-date-value">-</h4>
                                        <small class="forecast-label" id="full-date-note">Based on current growth
                                            rate</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>