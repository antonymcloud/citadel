{% extends "common/base.html" %}

{% block title %}Repository Details - Tower of Borg{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .chart-container {
        margin-bottom: 1rem;
        border-radius: 0.25rem;
        padding: 1rem;
        text-align: center;
        max-width: 100%;
        height: 100% !important;
        overflow: hidden;
    }
    .progress-label {
        position: absolute;
        right: 15px;
        font-weight: bold;
    }
    .forecast-label {
        font-size: 0.8rem;
        color: #6c757d;
    }
    .chart-wrapper {
        width: 100%;
        height: 300px;
        position: relative;
        overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-database me-2"></i>{{ repo.name }}</h1>
        <div class="btn-group">
            <a href="{{ url_for('backup.create_backup') }}?repo_id={{ repo.id }}" class="btn btn-success">
                <i class="fas fa-plus-circle me-2"></i>Create Backup
            </a>
            <a href="{{ url_for('backup.list_repositories') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Repositories
            </a>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-4">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Repository Details</h5>
                </div>
                <div class="card-body">
                    <table class="table">
                        <tr>
                            <th>Name:</th>
                            <td>{{ repo.name }}</td>
                        </tr>
                        <tr>
                            <th>Path:</th>
                            <td>{{ repo.path }}</td>
                        </tr>
                        <tr>
                            <th>Encryption:</th>
                            <td>{{ repo.encryption or 'None' }}</td>
                        </tr>
                        <tr>
                            <th>Created:</th>
                            <td>{{ repo.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        </tr>
                        <tr>
                            <th>Max Size:</th>
                            <td>
                                <span id="maxSizeDisplay">{{ repo.max_size }} GB</span>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" 
                                        data-bs-toggle="modal" data-bs-target="#maxSizeModal">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <div class="card shadow mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Maintenance</h5>
                </div>
                <div class="card-body">
                    <form id="pruneForm" action="{{ url_for('backup.prune_repository', repo_id=repo.id) }}" method="POST">
                        <h6>Prune Repository</h6>
                        <p class="text-muted">Remove archives according to retention policy</p>
                        
                        <div class="mb-3">
                            <label for="keep_daily" class="form-label">Keep daily</label>
                            <input type="number" class="form-control" id="keep_daily" name="keep_daily" value="7" min="1">
                        </div>
                        
                        <div class="mb-3">
                            <label for="keep_weekly" class="form-label">Keep weekly</label>
                            <input type="number" class="form-control" id="keep_weekly" name="keep_weekly" value="4" min="1">
                        </div>
                        
                        <div class="mb-3">
                            <label for="keep_monthly" class="form-label">Keep monthly</label>
                            <input type="number" class="form-control" id="keep_monthly" name="keep_monthly" value="6" min="1">
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-warning">Prune Repository</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Archives</h5>
                    <button id="refreshArchives" class="btn btn-sm btn-light">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="archivesList">
                        <div class="text-center">
                            <button id="loadArchives" class="btn btn-primary">
                                <i class="fas fa-list me-2"></i>Load Archives
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card shadow mt-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Recent Jobs</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Started</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for job in jobs %}
                                <tr>
                                    <td>{{ job.id }}</td>
                                    <td>
                                        {% if job.job_type == 'create' %}
                                            <span class="badge bg-primary">Create</span>
                                        {% elif job.job_type == 'prune' %}
                                            <span class="badge bg-warning">Prune</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ job.job_type }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if job.status == 'running' %}
                                            <span class="badge bg-warning">Running</span>
                                        {% elif job.status == 'success' %}
                                            <span class="badge bg-success">Success</span>
                                        {% elif job.status == 'failed' %}
                                            <span class="badge bg-danger">Failed</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ job.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ job.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    <td>
                                        <a href="{{ url_for('backup.job_detail', job_id=job.id) }}" class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center">No jobs found for this repository</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Analytics Dashboard Row -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Repository Analytics</h5>
                    <button id="refreshAnalytics" class="btn btn-sm btn-light">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div id="analytics-loading" class="text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
                        <p>Loading repository analytics...</p>
                    </div>
                    
                    <div id="analytics-content" class="d-none">
                        <div class="row mb-4">
                            <!-- Stats Overview -->
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Space Usage</h6>
                                        <div class="progress mb-2" style="height: 20px;">
                                            <div id="space-usage-bar" class="progress-bar bg-info" role="progressbar" 
                                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                                                <span id="usage-text">0% Used</span>
                                            </div>
                                        </div>
                                        <p class="text-center mb-0">
                                            <span id="current-size">0 GB</span> of <span id="max-size">{{ repo.max_size }} GB</span>
                                            (<span id="space-usage-percent">0%</span>)
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Estimated Runway</h6>
                                        <div class="d-flex align-items-center justify-content-center h-100">
                                            <div class="text-center w-100">
                                                <h3 id="estimated-runway" class="mb-1">-</h3>
                                                <p class="mb-0 small" id="runway-label">days remaining</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Average Compression</h6>
                                        <div class="d-flex align-items-center justify-content-center h-100">
                                            <div class="text-center w-100">
                                                <h3 id="avg-compression" class="mb-1">-</h3>
                                                <p class="mb-0 small">times smaller</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Job Statistics</h6>
                                        <div class="d-flex align-items-center justify-content-center h-100">
                                            <div class="text-center w-100">
                                                <div class="row g-2">
                                                    <div class="col-4">
                                                        <div class="border rounded p-2 bg-success text-white">
                                                            <strong id="successful-jobs" class="d-block">0</strong>
                                                            <small class="d-block">Success</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-4">
                                                        <div class="border rounded p-2 bg-danger text-white">
                                                            <strong id="failed-jobs" class="d-block">0</strong>
                                                            <small class="d-block">Failed</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-4">
                                                        <div class="border rounded p-2 bg-secondary text-white">
                                                            <strong id="total-jobs" class="d-block">0</strong>
                                                            <small class="d-block">Total</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- Growth Chart -->
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Repository Size Growth</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-wrapper" id="growth-chart-container">
                                            <div class="text-center">
                                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                                <p>Loading growth chart...</p>
                                            </div>
                                        </div>
                                        <div class="alert alert-info text-center d-none" id="growth-chart-no-data">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <span>No size data available yet. Create backups to see repository growth over time.</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Forecast Panel -->
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Growth Forecast</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="forecast-content">
                                            <table class="table table-sm">
                                                <tr>
                                                    <th>30 days:</th>
                                                    <td id="forecast-30">-</td>
                                                </tr>
                                                <tr>
                                                    <th>60 days:</th>
                                                    <td id="forecast-60">-</td>
                                                </tr>
                                                <tr>
                                                    <th>90 days:</th>
                                                    <td id="forecast-90">-</td>
                                                </tr>
                                            </table>
                                            <div class="alert alert-info mt-2">
                                                <small>
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Forecast is based on historical growth patterns and has 
                                                    <span id="forecast-confidence">medium</span> confidence.
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Second row for additional charts -->
                        <div class="row mt-4">
                            <!-- Backup Frequency Chart -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Backup Frequency</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-wrapper" id="frequency-chart-container">
                                            <div class="text-center">
                                                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                                <p>Loading frequency chart...</p>
                                            </div>
                                        </div>
                                        <div class="alert alert-info text-center d-none" id="frequency-chart-no-data">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <span>No backup frequency data available yet. Run more backups to see patterns.</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Backup Success Rate Chart -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Backup Success Rate</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-wrapper d-flex align-items-center justify-content-center">
                                            <div style="width: 200px; height: 200px; position: relative;">
                                                <canvas id="success-rate-chart"></canvas>
                                                <div class="position-absolute" style="top: 50%; left: 50%; transform: translate(-50%, -100%); text-align: center;">
                                                    <h3 class="mb-0" id="success-rate-percentage">-</h3>
                                                    <small>success rate</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Max Size Modal -->
<div class="modal fade" id="maxSizeModal" tabindex="-1" aria-labelledby="maxSizeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="maxSizeModalLabel">Set Maximum Repository Size</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="maxSizeForm">
                    <div class="mb-3">
                        <label for="maxSize" class="form-label">Maximum Size (GB)</label>
                        <input type="number" class="form-control" id="maxSize" name="maxSize" 
                               value="{{ repo.max_size }}" min="1" step="1">
                        <div class="form-text">Set the maximum expected size of this repository for forecasting purposes.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveMaxSize">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Chart.js is required for all charts on this page -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    $(document).ready(function() {
        // Set progress bar using direct DOM manipulation for better compatibility
        function setProgressBar(id, percent) {
            const bar = document.getElementById(id);
            if (bar) {
                console.log(`Direct DOM setting ${id} width to ${percent}%`);
                bar.style.width = percent + '%';
                bar.setAttribute('aria-valuenow', percent);
            }
        }

        // Load archives list
        $('#loadArchives, #refreshArchives').click(function() {
            $('#archivesList').html('<div class="text-center p-4"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-2">Loading archives...</p></div>');
            
            $.getJSON("{{ url_for('backup.list_archives', repo_id=repo.id) }}", function(data) {
                displayArchives(data);
            }).fail(function() {
                showError('Failed to communicate with server');
            });
        });
        
        // Handle prune form submission
        $('#pruneForm').submit(function(e) {
            e.preventDefault();
            
            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                data: $(this).serialize(),
                success: function(data) {
                    if (data.status === 'running') {
                        window.location.href = "{{ url_for('backup.job_detail', job_id=0) }}".replace('0', data.job_id);
                    } else {
                        showError('Failed to start prune job');
                    }
                },
                error: function() {
                    showError('Failed to communicate with server');
                }
            });
        });
        
        // Initialize analytics dashboard
        loadAnalytics();
        
        // Refresh analytics when button is clicked
        $('#refreshAnalytics').click(function() {
            loadAnalytics();
        });
        
        // Handle max size update
        $('#saveMaxSize').click(function() {
            const maxSize = $('#maxSize').val();
            if (!maxSize || maxSize < 1) {
                alert('Please enter a valid maximum size (at least 1 GB)');
                return;
            }
            
            $.ajax({
                url: "{{ url_for('backup.update_repository', repo_id=repo.id) }}",
                type: 'POST',
                data: {
                    max_size: maxSize
                },
                success: function(data) {
                    if (data.success) {
                        $('#maxSizeDisplay').text(maxSize + ' GB');
                        $('#max-size').text(maxSize + ' GB');
                        $('#maxSizeModal').modal('hide');
                        loadAnalytics(); // Reload analytics with new max size
                    } else {
                        showError('Failed to update maximum size');
                    }
                },
                error: function() {
                    showError('Failed to communicate with server');
                }
            });
        });
        
        // Display archives from data
        function displayArchives(archives) {
            if (!archives || archives.length === 0) {
                $('#archivesList').html('<div class="alert alert-info">No archives found in this repository.</div>');
                return;
            }
            
            let html = '<div class="list-group">';
            
            for (let archive of archives) {
                let archiveName = typeof archive === 'string' ? archive : archive.name;
                let archiveTime = archive.time ? new Date(archive.time).toLocaleString() : 'Unknown';
                let archiveSize = archive.size ? formatSize(archive.size) : 'Unknown';
                
                html += `
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">${archiveName}</h5>
                        <small>${archiveTime}</small>
                    </div>
                    <p class="mb-1">Size: ${archiveSize}</p>
                    <button class="btn btn-sm btn-info mount-btn" data-archive="${archiveName}">
                        <i class="fas fa-hdd me-1"></i>Mount
                    </button>
                    <button class="btn btn-sm btn-warning extract-btn" data-archive="${archiveName}">
                        <i class="fas fa-file-export me-1"></i>Extract
                    </button>
                </div>`;
            }
            
            html += '</div>';
            $('#archivesList').html(html);
        }
        
        // Analytics functions
        function loadAnalytics() {
            $('#analytics-loading').removeClass('d-none');
            $('#analytics-content').addClass('d-none');
            
            // Load repository statistics
            $.ajax({
                url: "{{ url_for('analytics.repository_stats_api', repo_id=repo.id) }}",
                type: 'GET',
                dataType: 'json',
                success: function(stats) {
                    console.log("Stats loaded successfully:", stats);
                    console.log("latest_size:", stats.latest_size, "space_usage:", stats.space_usage);
                    
                    // Convert any "None" string values to null
                    Object.keys(stats).forEach(key => {
                        if (stats[key] === "None") {
                            stats[key] = null;
                        }
                        
                        // Also check nested objects in size_trend
                        if (key === 'size_trend' && Array.isArray(stats[key])) {
                            stats[key].forEach(point => {
                                Object.keys(point).forEach(pointKey => {
                                    if (point[pointKey] === "None") {
                                        point[pointKey] = null;
                                    }
                                });
                            });
                        }
                    });
                    
                    updateAnalyticsDisplay(stats);
                    
                    // Load the growth chart
                    loadGrowthChart();
                    
                    // Load the frequency chart
                    loadFrequencyChart();
                    
                    // Create success rate chart
                    createSuccessRateChart(stats.successful_jobs, stats.failed_jobs);
                    
                    // Also load forecast data
                    $.ajax({
                        url: "{{ url_for('analytics.repository_forecast_api', repo_id=repo.id) }}",
                        type: 'GET',
                        dataType: 'json',
                        success: function(forecast) {
                            console.log("Forecast loaded successfully:", forecast);
                            
                            // Convert any "None" string values to null
                            if (forecast && forecast.forecast_points && Array.isArray(forecast.forecast_points)) {
                                forecast.forecast_points.forEach(point => {
                                    Object.keys(point).forEach(key => {
                                        if (point[key] === "None") {
                                            point[key] = null;
                                        }
                                    });
                                });
                            }
                            
                            updateForecastDisplay(forecast);
                        },
                        error: function(xhr, status, error) {
                            console.error('Failed to load forecast data:', error);
                            console.error('Response:', xhr.responseText);
                            
                            // Still show analytics without forecast
                            $('#analytics-loading').addClass('d-none');
                            $('#analytics-content').removeClass('d-none');
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load analytics data:', error);
                    console.error('Response:', xhr.responseText);
                    
                    // Show an error message in the analytics section
                    $('#analytics-loading').addClass('d-none');
                    $('#analytics-content').removeClass('d-none');
                    
                    // Add error alert
                    $('.card-body', $('#analytics-content').closest('.card')).prepend(
                        '<div class="alert alert-danger">' +
                        '<i class="fas fa-exclamation-circle me-2"></i>' +
                        'Failed to load analytics data: ' + error +
                        '</div>'
                    );
                }
            });
        }
        
        function loadGrowthChart() {
            console.log("Loading growth chart...");
            $.ajax({
                url: "{{ url_for('analytics.repository_growth_chart', repo_id=repo.id) }}",
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    console.log("Growth chart response:", response);
                    if (response.chart_html) {
                        // Insert chart HTML
                        $('#growth-chart-container').html(response.chart_html);
                        $('#growth-chart-no-data').addClass('d-none');
                        
                        // If it's sample data, show a note
                        if (response.is_sample_data) {
                            $('#growth-chart-container').append(
                                '<div class="alert alert-info mt-3 text-center">' +
                                '<i class="fas fa-info-circle me-2"></i>' +
                                'No real data available yet. Create backups to see repository growth over time.' +
                                '</div>'
                            );
                        }
                        
                        console.log("Growth chart loaded successfully");
                    } else if (response.error) {
                        console.error("Error loading growth chart:", response.error);
                        $('#growth-chart-container').addClass('d-none');
                        $('#growth-chart-no-data').removeClass('d-none');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load growth chart:', error);
                    $('#growth-chart-container').addClass('d-none');
                    $('#growth-chart-no-data').removeClass('d-none');
                }
            });
        }
        
        function loadFrequencyChart() {
            console.log("Loading frequency chart...");
            $.ajax({
                url: "{{ url_for('analytics.repository_frequency_chart', repo_id=repo.id) }}",
                type: 'GET',
                dataType: 'json',
                success: function(response) {
                    console.log("Frequency chart response:", response);
                    if (response.chart_html) {
                        // Insert chart HTML
                        $('#frequency-chart-container').html(response.chart_html);
                        $('#frequency-chart-no-data').addClass('d-none');
                        
                        // If it's sample data, show a note
                        if (response.is_sample_data) {
                            $('#frequency-chart-container').append(
                                '<div class="alert alert-info mt-3 text-center">' +
                                '<i class="fas fa-info-circle me-2"></i>' +
                                'No backup frequency data available yet. Run more backups to see patterns.' +
                                '</div>'
                            );
                        }
                        
                        console.log("Frequency chart loaded successfully");
                    } else if (response.error) {
                        console.error("Error loading frequency chart:", response.error);
                        $('#frequency-chart-container').addClass('d-none');
                        $('#frequency-chart-no-data').removeClass('d-none');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load frequency chart:', error);
                    $('#frequency-chart-container').addClass('d-none');
                    $('#frequency-chart-no-data').removeClass('d-none');
                }
            });
        }
        
        function createSuccessRateChart(successCount, failedCount) {
            const ctx = document.getElementById('success-rate-chart').getContext('2d');
            
            // Calculate percentage
            const total = successCount + failedCount;
            const successRate = total > 0 ? Math.round((successCount / total) * 100) : 0;
            
            // Update the percentage display
            $('#success-rate-percentage').text(successRate + '%');
            
            // Create doughnut chart
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Success', 'Failed'],
                    datasets: [{
                        data: [successCount || 1, failedCount || 0],  // Use at least 1 for success if there's no data
                        backgroundColor: ['rgba(40, 167, 69, 0.7)', 'rgba(220, 53, 69, 0.7)'],
                        borderColor: ['rgba(40, 167, 69, 1)', 'rgba(220, 53, 69, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const percentage = total > 0 
                                        ? Math.round((value / total) * 100) 
                                        : (context.dataIndex === 0 ? 100 : 0); // 100% success if no data
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // If there's no data, show a note
            if (total === 0) {
                // Add a note below the chart
                $(ctx.canvas).parent().after(
                    '<div class="alert alert-info mt-3 text-center">' +
                    '<i class="fas fa-info-circle me-2"></i>' +
                    'No backup jobs have been run yet.' +
                    '</div>'
                );
            }
        }
        
        function updateAnalyticsDisplay(stats) {
            // Debug log to see what's coming from the API
            console.log("Received stats from API:", stats);
            console.log("Estimated runway value:", stats.estimated_runway);
            
            // Update space usage
            if (stats.latest_size !== null && stats.latest_size !== undefined) {
                const usagePercent = stats.space_usage !== null && stats.space_usage !== undefined ? stats.space_usage : 0;
                console.log("Setting space usage bar width to " + usagePercent + "%");
                
                // Ensure we have a valid percentage (should be between 0-100)
                const validPercent = Math.min(Math.max(0, usagePercent), 100);
                const roundedPercent = Math.round(validPercent * 10) / 10; // Round to 1 decimal place
                
                // Try multiple approaches to set the progress bar
                // 1. Standard jQuery CSS
                $('#space-usage-bar').css('width', validPercent + '%');
                
                // 2. Update the aria values as well
                $('#space-usage-bar').attr('aria-valuenow', validPercent);
                
                // 3. Update the text display of the percentage
                $('#space-usage-percent').text(roundedPercent + '%');
                
                // 4. Also try with .width() method
                $('#space-usage-bar').width(validPercent + '%');
                
                // 2. Direct DOM manipulation
                setProgressBar('space-usage-bar', validPercent);
                
                // 3. Delayed update with !important flag
                setTimeout(function() {
                    console.log("Delayed setting bar width to " + validPercent + "%");
                    // Apply width with important flag to override any conflicting styles
                    $('#space-usage-bar').attr('style', 'width: ' + validPercent + '% !important');
                    
                    // Update ARIA attributes
                    $('#space-usage-bar').attr('aria-valuenow', validPercent);
                    $('#usage-text').text(roundedPercent.toFixed(1) + '% Used');
                    console.log("Updated usage-text to: " + roundedPercent.toFixed(1) + '% Used');
                }, 100);
                
                $('#current-size').text((stats.latest_size).toFixed(2) + ' GB');
                
                // Color coding for usage
                if (validPercent > 90) {
                    $('#space-usage-bar').removeClass('bg-info bg-warning').addClass('bg-danger');
                } else if (validPercent > 70) {
                    $('#space-usage-bar').removeClass('bg-info bg-danger').addClass('bg-warning');
                } else {
                    $('#space-usage-bar').removeClass('bg-warning bg-danger').addClass('bg-info');
                }
            } else {
                console.log("No latest_size data available");
                // Set a default value
                $('#space-usage-bar').css('width', '10%');
                $('#current-size').text('0.00 GB');
            }
            
            // Update runway estimate
            console.log("Estimated runway value from API:", stats.estimated_runway);
            
            if (stats.estimated_runway !== null && stats.estimated_runway !== undefined) {
                // Remove any existing colors first
                $('#estimated-runway').removeClass('text-danger text-warning text-success');
                
                // Format the runway value appropriately
                let runwayValue = parseInt(stats.estimated_runway);
                console.log("Parsed runway value:", runwayValue);
                
                // Handle zero values specifically
                if (runwayValue === 0) {
                    console.log("Runway value is zero, using default value");
                    runwayValue = 365; // Default to 1 year
                }
                
                // Color coding for runway
                if (runwayValue < 30) {
                    $('#estimated-runway').addClass('text-danger');
                    $('#estimated-runway').text(runwayValue);
                    $('#runway-label').text('days remaining');
                } else if (runwayValue < 90) {
                    $('#estimated-runway').addClass('text-warning');
                    $('#estimated-runway').text(runwayValue);
                    $('#runway-label').text('days remaining');
                } else if (runwayValue < 365) {
                    // Between 3 months and 1 year - show in months
                    $('#estimated-runway').addClass('text-success');
                    let months = Math.round(runwayValue / 30);
                    $('#estimated-runway').text(months);
                    $('#runway-label').text('months remaining');
                } else if (runwayValue < 730) {
                    // Between 1-2 years - show as a year plus months
                    $('#estimated-runway').addClass('text-success');
                    let remainingMonths = Math.round((runwayValue - 365) / 30);
                    if (remainingMonths > 0) {
                        $('#estimated-runway').text('1+');
                        $('#runway-label').text('years remaining');
                    } else {
                        $('#estimated-runway').text('1');
                        $('#runway-label').text('year remaining');
                    }
                } else {
                    // More than 2 years - round to years
                    $('#estimated-runway').addClass('text-success');
                    let years = Math.round(runwayValue / 365);
                    $('#estimated-runway').text(years);
                    $('#runway-label').text('years remaining');
                }
            }
            
            // Update compression ratio
            if (stats.avg_compression_ratio) {
                $('#avg-compression').text(stats.avg_compression_ratio.toFixed(2) + 'x');
            }
            
            // Update job statistics
            $('#total-jobs').text(stats.total_jobs || 0);
            $('#successful-jobs').text(stats.successful_jobs || 0);
            $('#failed-jobs').text(stats.failed_jobs || 0);
            
            // Show the analytics content
            $('#analytics-loading').addClass('d-none');
            $('#analytics-content').removeClass('d-none');
        }
        
        function updateForecastDisplay(forecast) {
            if (!forecast || !forecast.forecast_points || forecast.forecast_points.length === 0) {
                console.log("No forecast data available");
                return;
            }
            
            console.log("Processing forecast data:", forecast);
            
            // Find the forecast points for 30, 60, and 90 days
            const points = forecast.forecast_points;
            
            // Convert first date string to Date object
            const firstDate = new Date(points[0].timestamp);
            
            // Find points closest to 30, 60, and 90 days
            const point30 = points.find(p => {
                const pointDate = new Date(p.timestamp);
                const diffDays = (pointDate - firstDate) / (1000 * 60 * 60 * 24);
                return diffDays >= 30 && diffDays < 40;
            });
            
            const point60 = points.find(p => {
                const pointDate = new Date(p.timestamp);
                const diffDays = (pointDate - firstDate) / (1000 * 60 * 60 * 24);
                return diffDays >= 60 && diffDays < 70;
            });
            
            const point90 = points.find(p => {
                const pointDate = new Date(p.timestamp);
                const diffDays = (pointDate - firstDate) / (1000 * 60 * 60 * 24);
                return diffDays >= 90;
            });
            
            console.log("Forecast points:", {point30, point60, point90});
            
            // Update forecast displays
            if (point30 && point30.size_gb !== null && point30.size_gb !== undefined) {
                $('#forecast-30').text(point30.size_gb.toFixed(2) + ' GB');
            }
            if (point60 && point60.size_gb !== null && point60.size_gb !== undefined) {
                $('#forecast-60').text(point60.size_gb.toFixed(2) + ' GB');
            }
            if (point90 && point90.size_gb !== null && point90.size_gb !== undefined) {
                $('#forecast-90').text(point90.size_gb.toFixed(2) + ' GB');
            }
            
            // Update confidence text
            let confidenceText = 'medium';
            if (forecast.forecast_confidence >= 0.8) {
                confidenceText = 'high';
            } else if (forecast.forecast_confidence < 0.5) {
                confidenceText = 'low';
            }
            $('#forecast-confidence').text(confidenceText);
        }
        
        // Utility functions
        function formatSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function showError(message) {
            const errorHtml = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>`;
            
            $('#archivesList').html(errorHtml);
        }
    });
</script>
{% endblock %}
