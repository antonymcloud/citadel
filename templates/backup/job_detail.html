{% extends "base.html" %}

{% block title %}Job Details - Tower of Borg{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-tasks me-2"></i>Job Details</h1>
        <a href="{{ url_for('backup.list_jobs') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Jobs
        </a>
    </div>
    
    <div class="row">
        <div class="col-md-4">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Job Summary</h5>
                </div>
                <div class="card-body">
                    <table class="table">
                        <tr>
                            <th>Job ID:</th>
                            <td>{{ job.id }}</td>
                        </tr>
                        <tr>
                            <th>Type:</th>
                            <td>
                                {% if job.job_type == 'create' %}
                                    <span class="badge bg-primary">Create</span>
                                {% elif job.job_type == 'prune' %}
                                    <span class="badge bg-warning">Prune</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ job.job_type }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Status:</th>
                            <td>
                                {% if job.status == 'running' %}
                                    <span class="badge bg-warning">Running</span>
                                {% elif job.status == 'success' %}
                                    <span class="badge bg-success">Success</span>
                                {% elif job.status == 'failed' %}
                                    <span class="badge bg-danger">Failed</span>
                                {% elif job.status == 'cancelled' %}
                                    <span class="badge bg-secondary">Cancelled</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ job.status }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Repository:</th>
                            <td><a href="{{ url_for('backup.repository_detail', repo_id=job.repository.id) }}">{{ job.repository.name }}</a></td>
                        </tr>
                        {% if job.archive_name %}
                        <tr>
                            <th>Archive:</th>
                            <td>{{ job.archive_name }}</td>
                        </tr>
                        {% endif %}
                        
                        {% if job.source %}
                        <tr>
                            <th>Source:</th>
                            <td>
                                <a href="{{ url_for('sources.source_detail', source_id=job.source.id) }}">
                                    {{ job.source.name }}
                                    {% if job.source.source_type == 'local' %}
                                    <span class="badge bg-primary">Local</span>
                                    {% else %}
                                    <span class="badge bg-success">SSH</span>
                                    {% endif %}
                                </a>
                            </td>
                        </tr>
                        <tr>
                            <th>Source Path:</th>
                            <td>{{ job.source.get_formatted_path() }}</td>
                        </tr>
                        {% elif job.source_path %}
                        <tr>
                            <th>Source Path:</th>
                            <td>{{ job.source_path }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Started:</th>
                            <td>{{ job.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        </tr>
                        {% if job.completed_at %}
                        <tr>
                            <th>Completed:</th>
                            <td>{{ job.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        </tr>
                        <tr>
                            <th>Duration:</th>
                            <td>{{ (job.completed_at - job.timestamp).total_seconds() }} seconds</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
            
            {# Display job statistics if available #}
            {% set metadata = job.get_metadata() %}
            <div class="card shadow mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Debug Information</h5>
                </div>
                <div class="card-body">
                    <p>Has metadata: {{ metadata is not none }}</p>
                    <p>Metadata keys: {{ metadata.keys()|list }}</p>
                    <p>Has stats: {{ 'stats' in metadata }}</p>
                    {% if 'stats' in metadata %}
                        <p>Stats keys: {{ metadata.stats.keys()|list }}</p>
                    {% endif %}
                </div>
            </div>
            
            {% if metadata and metadata.stats %}
            <div class="card shadow mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Backup Statistics</h5>
                </div>
                <div class="card-body">
                    <table class="table table-hover">
                        {% if metadata.stats.nfiles is defined %}
                        <tr>
                            <th><i class="fas fa-file me-2"></i>Files:</th>
                            <td class="font-weight-bold">{{ metadata.stats.nfiles }}</td>
                        </tr>
                        {% endif %}
                        
                        {% if metadata.stats.original_size is defined %}
                        <tr>
                            <th><i class="fas fa-database me-2"></i>Original Size:</th>
                            <td class="font-weight-bold">{{ metadata.stats.original_size|filesizeformat }}</td>
                        </tr>
                        {% endif %}
                        
                        {% if metadata.stats.compressed_size is defined %}
                        <tr>
                            <th><i class="fas fa-compress me-2"></i>Compressed Size:</th>
                            <td class="font-weight-bold">{{ metadata.stats.compressed_size|filesizeformat }}</td>
                        </tr>
                        {% endif %}
                        
                        {% if metadata.stats.deduplicated_size is defined %}
                        <tr>
                            <th><i class="fas fa-clone me-2"></i>Deduplicated Size:</th>
                            <td class="font-weight-bold">{{ metadata.stats.deduplicated_size|filesizeformat }}</td>
                        </tr>
                        {% endif %}
                        
                        {% if metadata.stats.duration is defined %}
                        <tr>
                            <th><i class="fas fa-clock me-2"></i>Duration:</th>
                            <td>{{ metadata.stats.duration }} seconds</td>
                        </tr>
                        {% endif %}
                    </table>

                    {% if metadata.stats.unique_chunks is defined %}
                    <hr>
                    <h6 class="mb-3"><i class="fas fa-cubes me-2"></i>Chunk Information</h6>
                    <table class="table table-sm">
                        <tr>
                            <th>Unique Chunks:</th>
                            <td>{{ metadata.stats.unique_chunks }}</td>
                        </tr>
                        {% if metadata.stats.unique_chunks_size is defined %}
                        <tr>
                            <th>Chunks Size:</th>
                            <td>{{ metadata.stats.unique_chunks_size|filesizeformat }}</td>
                        </tr>
                        {% endif %}
                        {% if metadata.stats.unique_chunks_avg_size is defined %}
                        <tr>
                            <th>Average Chunk Size:</th>
                            <td>{{ metadata.stats.unique_chunks_avg_size|filesizeformat }}</td>
                        </tr>
                        {% endif %}
                    </table>
                    {% endif %}
                    
                    {% if metadata.stats.pruned_archives_count is defined or metadata.stats.kept_archives_count is defined %}
                    <hr>
                    <h6 class="mb-3"><i class="fas fa-broom me-2"></i>Pruning Information</h6>
                    <table class="table table-sm">
                        {% if metadata.stats.kept_archives_count is defined %}
                        <tr>
                            <th>Archives Kept:</th>
                            <td>{{ metadata.stats.kept_archives_count }}</td>
                        </tr>
                        {% endif %}
                        {% if metadata.stats.pruned_archives_count is defined %}
                        <tr>
                            <th>Archives Pruned:</th>
                            <td>{{ metadata.stats.pruned_archives_count }}</td>
                        </tr>
                        {% endif %}
                    </table>
                    {% endif %}                        {% if metadata.stats.compressed_size is defined and metadata.stats.original_size is defined %}
                        <tr>
                            <th><i class="fas fa-percentage me-2"></i>Compression Ratio:</th>
                            <td>
                                {% set ratio = (metadata.stats.compressed_size / metadata.stats.original_size * 100)|round(1) %}
                                {% set savings = (100 - ratio)|round(1) %}
                                <div>
                                    <strong>{{ ratio }}%</strong> of original size (saved {{ savings }}%)
                                    <div class="mt-1" style="height: 8px; background-color: #e9ecef; border-radius: 4px;">
                                        <div style="height: 100%; width: {{ ratio }}%; background-color: #28a745; border-radius: 4px;"></div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        
                        {% if metadata.stats.deduplicated_size is defined and metadata.stats.original_size is defined %}
                        <tr>
                            <th><i class="fas fa-percentage me-2"></i>Deduplication Ratio:</th>
                            <td>
                                {% set ratio = (metadata.stats.deduplicated_size / metadata.stats.original_size * 100)|round(1) %}
                                {% set savings = (100 - ratio)|round(1) %}
                                <div>
                                    <strong>{{ ratio }}%</strong> of original size (saved {{ savings }}%)
                                    <div class="mt-1" style="height: 8px; background-color: #e9ecef; border-radius: 4px;">
                                        <div style="height: 100%; width: {{ ratio }}%; background-color: #17a2b8; border-radius: 4px;"></div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                    </table>

                    {% if metadata.stats.all_archives_original_size is defined %}
                    <hr>
                    <div class="card mt-3 bg-light">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0"><i class="fas fa-archive me-2"></i>Repository Totals</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm mb-0">
                                <tr>
                                    <th>All Archives Size:</th>
                                    <td>{{ metadata.stats.all_archives_original_size|filesizeformat }}</td>
                                </tr>
                                <tr>
                                    <th>All Archives Compressed:</th>
                                    <td>{{ metadata.stats.all_archives_compressed_size|filesizeformat }}</td>
                                </tr>
                                <tr>
                                    <th>All Archives Deduplicated:</th>
                                    <td>{{ metadata.stats.all_archives_deduplicated_size|filesizeformat }}</td>
                                </tr>
                                {% if metadata.stats.all_archives_original_size and metadata.stats.all_archives_deduplicated_size %}
                                <tr>
                                    <th>Total Space Saved:</th>
                                    <td>{{ (metadata.stats.all_archives_original_size - metadata.stats.all_archives_deduplicated_size)|filesizeformat }}</td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Job Output</h5>
                    {% if job.log_output %}
                    <button class="btn btn-sm btn-light" onclick="copyToClipboard()">
                        <i class="fas fa-copy me-1"></i>Copy
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if job.status == 'running' %}
                    <div class="alert alert-warning">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-spinner fa-spin me-2"></i>This job is running.
                            </div>
                            <button id="cancelJobBtn" class="btn btn-danger">
                                <i class="fas fa-stop-circle me-2"></i>Cancel Job
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div id="jobOutput" class="bg-dark text-light p-3 rounded" style="max-height: 500px; overflow-y: auto;">
                        <pre id="plainTextOutput" style="white-space: pre-wrap; margin-bottom: 0;">{{ job.log_output }}</pre>
                    </div>
                    
                    <div class="mt-3 d-flex justify-content-between">
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" id="btnAutoScroll">
                                <i class="fas fa-arrow-down me-1"></i>Auto-scroll
                            </button>
                            <span class="text-muted ms-2" id="autoScrollStatus">Enabled</span>
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="copyToClipboard()">
                            <i class="fas fa-copy me-1"></i>Copy
                        </button>
                    </div>
                    
                    <script>
                        // Auto-scroll to bottom of output
                        function scrollOutputToBottom() {
                            const output = document.getElementById('jobOutput');
                            output.scrollTop = output.scrollHeight;
                        }
                        
                        // Initial scroll to bottom
                        scrollOutputToBottom();
                        
                        // Auto-scroll state
                        let autoScrollEnabled = true;
                        
                        // Toggle auto-scroll
                        document.getElementById('btnAutoScroll').addEventListener('click', function() {
                            autoScrollEnabled = !autoScrollEnabled;
                            document.getElementById('autoScrollStatus').textContent = autoScrollEnabled ? 'Enabled' : 'Disabled';
                            if (autoScrollEnabled) {
                                scrollOutputToBottom();
                            }
                        });
                        
                        // Copy to clipboard
                        function copyToClipboard() {
                            const output = document.getElementById('plainTextOutput');
                            const textArea = document.createElement('textarea');
                            textArea.value = output.textContent;
                            document.body.appendChild(textArea);
                            textArea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textArea);
                            
                            // Show a temporary tooltip
                            const btn = event.target.closest('button');
                            const originalText = btn.innerHTML;
                            btn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
                            setTimeout(() => {
                                btn.innerHTML = originalText;
                            }, 2000);
                        }
                        function scrollOutputToBottom() {
                            const output = document.getElementById('jobOutput');
                            output.scrollTop = output.scrollHeight;
                        }
                        
                        // Update output with new content
                        function updateOutput(content) {
                            const outputElem = document.getElementById('plainTextOutput');
                            outputElem.textContent = content;
                            
                            // Auto-scroll if enabled
                            if (autoScrollEnabled) {
                                scrollOutputToBottom();
                            }
                        }
                        
                        // Set error highlighting 
                        function highlightConsoleOutput() {
                            const output = document.getElementById('plainTextOutput');
                            const content = output.textContent;
                            
                            // Only process if we have content
                            if (content) {
                                // Replace [ERROR] with styled version
                                const highlightedContent = content
                                    .replace(/\[ERROR\] (.*?)(?=\n|$)/g, '<span class="text-danger">[ERROR] $1</span>')
                                    .replace(/\[WARN\] (.*?)(?=\n|$)/g, '<span class="text-warning">[WARN] $1</span>');
                                
                                // Set the HTML content
                                output.innerHTML = highlightedContent;
                            }
                        }
                        
                        // Initial highlighting
                        highlightConsoleOutput();
                        
                        // Initial rendering of output
                        const rawOutput = document.getElementById('rawOutput').textContent;
                        if (rawOutput) {
                            formatJsonOutput(rawOutput);
                        }
                        
                        // Toggle between raw and formatted output
                        document.getElementById('toggleRawOutput').addEventListener('change', function(e) {
                            document.getElementById('structuredOutput').style.display = e.target.checked ? 'none' : 'block';
                            document.getElementById('rawOutput').style.display = e.target.checked ? 'block' : 'none';
                        });
                        
                        function copyToClipboard() {
                            const output = document.getElementById('rawOutput');
                            const textArea = document.createElement('textarea');
                            textArea.value = output.textContent;
                            document.body.appendChild(textArea);
                            textArea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textArea);
                            
                            // Show a temporary tooltip
                            const btn = event.target.closest('button');
                            const originalText = btn.innerHTML;
                            btn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
                            setTimeout(() => {
                                btn.innerHTML = originalText;
                            }, 2000);
                        }
                    </script>
                    
                    {% if not job.log_output %}
                    <div class="alert alert-info">No output available for this job.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const jobId = "{{ job.id }}";
        const isRunning = "{{ job.status }}" === "running";
        let outputLength = "{{ job.log_output|length if job.log_output else 0 }}";
        outputLength = parseInt(outputLength, 10);
        let pollingInterval;
        
        // Setup polling for running jobs
        if (isRunning) {
            startPolling();
        }
        
        // Handle job cancellation
        const cancelButton = document.getElementById('cancelJobBtn');
        if (cancelButton) {
            cancelButton.addEventListener('click', function() {
                if (confirm('Are you sure you want to cancel this job?')) {
                    cancelJob();
                }
            });
        }
        
        // Start polling for updates
        function startPolling() {
            // Poll every second for new output
            pollingInterval = setInterval(fetchJobUpdates, 1000);
        }
        
        // Fetch job updates with incremental output
        function fetchJobUpdates() {
            fetch(`/backup/api/jobs/${jobId}?offset=${outputLength}`)
                .then(response => response.json())
                .then(data => {
                    // Update job status if changed
                    if (data.status !== 'running') {
                        clearInterval(pollingInterval);
                        // Refresh the page to get the final state
                        setTimeout(() => window.location.reload(), 1000);
                    }
                    
                    // Update output if any
                    if (data.log_output) {
                        // Update the output element with new content
                        updateOutput(data.log_output);
                        
                        // Apply syntax highlighting
                        highlightConsoleOutput();
                        
                        outputLength = data.total_output_length;
                    }
                })
                .catch(error => {
                    console.error('Error fetching job updates:', error);
                });
        }
        
        // Cancel the job
        function cancelJob() {
            fetch(`/backup/api/jobs/${jobId}/cancel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Job cancellation requested. The job will stop shortly.');
                } else {
                    alert('Failed to cancel job: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error cancelling job:', error);
                alert('Error cancelling job: ' + error);
            });
        }
    });
</script>
{% endblock %}
