{% extends "base.html" %}

{% block title %}Job Details - Tower of Borg{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-tasks me-2"></i>Job Details</h1>
        <a href="{{ url_for('backup.list_jobs') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Jobs
        </a>
    </div>
    
    <div class="row">
        <div class="col-md-4">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Job Summary</h5>
                </div>
                <div class="card-body">
                    <table class="table">
                        <tr>
                            <th>Job ID:</th>
                            <td>{{ job.id }}</td>
                        </tr>
                        <tr>
                            <th>Type:</th>
                            <td>
                                {% if job.job_type == 'create' %}
                                    <span class="badge bg-primary">Create</span>
                                {% elif job.job_type == 'prune' %}
                                    <span class="badge bg-warning">Prune</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ job.job_type }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Status:</th>
                            <td>
                                {% if job.status == 'running' %}
                                    <span class="badge bg-warning">Running</span>
                                {% elif job.status == 'success' %}
                                    <span class="badge bg-success">Success</span>
                                {% elif job.status == 'failed' %}
                                    <span class="badge bg-danger">Failed</span>
                                {% elif job.status == 'cancelled' %}
                                    <span class="badge bg-secondary">Cancelled</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ job.status }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Repository:</th>
                            <td><a href="{{ url_for('backup.repository_detail', repo_id=job.repository.id) }}">{{ job.repository.name }}</a></td>
                        </tr>
                        {% if job.archive_name %}
                        <tr>
                            <th>Archive:</th>
                            <td>{{ job.archive_name }}</td>
                        </tr>
                        {% endif %}
                        
                        {% if job.source %}
                        <tr>
                            <th>Source:</th>
                            <td>
                                <a href="{{ url_for('sources.source_detail', source_id=job.source.id) }}">
                                    {{ job.source.name }}
                                    {% if job.source.source_type == 'local' %}
                                    <span class="badge bg-primary">Local</span>
                                    {% else %}
                                    <span class="badge bg-success">SSH</span>
                                    {% endif %}
                                </a>
                            </td>
                        </tr>
                        <tr>
                            <th>Source Path:</th>
                            <td>{{ job.source.get_formatted_path() }}</td>
                        </tr>
                        {% elif job.source_path %}
                        <tr>
                            <th>Source Path:</th>
                            <td>{{ job.source_path }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Started:</th>
                            <td>{{ job.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        </tr>
                        {% if job.completed_at %}
                        <tr>
                            <th>Completed:</th>
                            <td>{{ job.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        </tr>
                        <tr>
                            <th>Duration:</th>
                            <td>{{ (job.completed_at - job.timestamp).total_seconds() }} seconds</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Job Output</h5>
                    {% if job.log_output %}
                    <button class="btn btn-sm btn-light" onclick="copyToClipboard()">
                        <i class="fas fa-copy me-1"></i>Copy
                    </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if job.status == 'running' %}
                    <div class="alert alert-warning">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-spinner fa-spin me-2"></i>This job is running.
                            </div>
                            <button id="cancelJobBtn" class="btn btn-danger">
                                <i class="fas fa-stop-circle me-2"></i>Cancel Job
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div id="jobOutput" class="bg-dark text-light p-3 rounded" style="max-height: 500px; overflow-y: auto;">
                        <div id="structuredOutput">
                            <!-- Structured output will be rendered here -->
                        </div>
                        <pre id="rawOutput" style="display: none; white-space: pre-wrap;">{{ job.log_output }}</pre>
                    </div>
                    
                    <div class="mt-3 d-flex justify-content-between">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="toggleRawOutput">
                            <label class="form-check-label" for="toggleRawOutput">Show Raw Output</label>
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="copyToClipboard()">
                            <i class="fas fa-copy me-1"></i>Copy
                        </button>
                    </div>
                    
                    <script>
                        // Auto-scroll to bottom of output
                        function scrollOutputToBottom() {
                            const output = document.getElementById('jobOutput');
                            output.scrollTop = output.scrollHeight;
                        }
                        
                        // Format a JSON string for display
                        function formatJsonOutput(jsonStr) {
                            try {
                                // Try to parse the JSON
                                const data = JSON.parse(jsonStr);
                                const structuredOutput = document.getElementById('structuredOutput');
                                structuredOutput.innerHTML = '';
                                
                                // Process structured data array
                                if (data.structured_data && Array.isArray(data.structured_data)) {
                                    data.structured_data.forEach(item => {
                                        const msgDiv = document.createElement('div');
                                        msgDiv.className = 'mb-2';
                                        
                                        // Format based on the type of message following Borg's format
                                        if (item.type === 'log_message') {
                                            // Standard log messages
                                            let badgeClass = 'bg-info';
                                            let icon = 'info-circle';
                                            
                                            if (item.levelname === 'ERROR') {
                                                badgeClass = 'bg-danger';
                                                icon = 'exclamation-circle';
                                            } else if (item.levelname === 'WARNING') {
                                                badgeClass = 'bg-warning';
                                                icon = 'exclamation-triangle';
                                            }
                                            
                                            msgDiv.innerHTML = `
                                                <div class="d-flex">
                                                    <span class="badge ${badgeClass} me-2"><i class="fas fa-${icon}"></i></span>
                                                    <div>${item.message}</div>
                                                </div>
                                            `;
                                        } else if (item.type === 'progress_percent') {
                                            // Progress updates
                                            if (item.finished) {
                                                msgDiv.innerHTML = `
                                                    <div class="alert alert-success">
                                                        <i class="fas fa-check-circle me-2"></i>Operation completed
                                                    </div>
                                                `;
                                            } else {
                                                const percent = item.current ? Math.round((item.current / item.total) * 100) : 0;
                                                msgDiv.innerHTML = `
                                                    <div>
                                                        <small class="text-muted">${item.message || ''}</small>
                                                        <div class="progress">
                                                            <div class="progress-bar" role="progressbar" 
                                                                style="width: ${percent}%" 
                                                                aria-valuenow="${percent}" 
                                                                aria-valuemin="0" 
                                                                aria-valuemax="100">
                                                                ${percent}%
                                                            </div>
                                                        </div>
                                                    </div>
                                                `;
                                            }
                                        } else if (item.type === 'progress_message') {
                                            // Simple progress messages
                                            if (item.finished) {
                                                msgDiv.innerHTML = `
                                                    <div class="alert alert-success">
                                                        <i class="fas fa-check-circle me-2"></i>${item.msgid || 'Operation'} completed
                                                    </div>
                                                `;
                                            } else {
                                                msgDiv.innerHTML = `
                                                    <div class="d-flex align-items-center">
                                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                                        <div>${item.message || 'Processing...'}</div>
                                                    </div>
                                                `;
                                            }
                                        } else if (item.type === 'file_status') {
                                            // File status updates (single character status)
                                            let statusText = '';
                                            let statusBadge = '';
                                            
                                            switch(item.status) {
                                                case 'A':
                                                    statusText = 'Added';
                                                    statusBadge = 'bg-success';
                                                    break;
                                                case 'M':
                                                    statusText = 'Modified';
                                                    statusBadge = 'bg-warning';
                                                    break;
                                                case 'U':
                                                    statusText = 'Unchanged';
                                                    statusBadge = 'bg-info';
                                                    break;
                                                case 'd':
                                                    statusText = 'Directory';
                                                    statusBadge = 'bg-primary';
                                                    break;
                                                default:
                                                    statusText = item.status;
                                                    statusBadge = 'bg-secondary';
                                            }
                                            
                                            msgDiv.innerHTML = `
                                                <div class="d-flex">
                                                    <span class="badge ${statusBadge} me-2">${statusText}</span>
                                                    <div class="text-truncate">${item.path}</div>
                                                </div>
                                            `;
                                        } else if (item.type === 'archive_progress') {
                                            // Archive progress information
                                            const originalSize = formatBytes(item.original_size);
                                            const compressedSize = formatBytes(item.compressed_size);
                                            const deduplicatedSize = formatBytes(item.deduplicated_size);
                                            
                                            msgDiv.innerHTML = `
                                                <div class="card mb-2">
                                                    <div class="card-header">
                                                        <strong>Archive Progress</strong> - ${item.nfiles || 0} files processed
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row">
                                                            <div class="col-md-4">
                                                                <strong>Original:</strong> ${originalSize}
                                                            </div>
                                                            <div class="col-md-4">
                                                                <strong>Compressed:</strong> ${compressedSize}
                                                            </div>
                                                            <div class="col-md-4">
                                                                <strong>Deduplicated:</strong> ${deduplicatedSize}
                                                            </div>
                                                        </div>
                                                        <div class="mt-2">
                                                            <strong>Path:</strong> ${item.path || 'N/A'}
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        } else {
                                            // Generic JSON
                                            msgDiv.innerHTML = `
                                                <div class="card mb-2">
                                                    <div class="card-header">
                                                        <strong>${item.type || 'JSON Data'}</strong>
                                                    </div>
                                                    <div class="card-body">
                                                        <pre class="mb-0">${JSON.stringify(item, null, 2)}</pre>
                                                    </div>
                                                </div>
                                            `;
                                        }
                                        
                                        structuredOutput.appendChild(msgDiv);
                                    });
                                } else {
                                    // If not in our expected format, just show formatted JSON
                                    structuredOutput.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                                }
                            } catch (e) {
                                // If it's not valid JSON, just display as-is
                                const structuredOutput = document.getElementById('structuredOutput');
                                structuredOutput.innerHTML = `<pre>${jsonStr}</pre>`;
                                console.error('Error parsing JSON:', e);
                            }
                            
                            // Scroll to bottom
                            scrollOutputToBottom();
                        }
                        
                        // Format bytes to human-readable form
                        function formatBytes(bytes, decimals = 2) {
                            if (bytes === undefined || bytes === null) return 'N/A';
                            if (bytes === 0) return '0 Bytes';
                            
                            const k = 1024;
                            const dm = decimals < 0 ? 0 : decimals;
                            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
                            
                            const i = Math.floor(Math.log(bytes) / Math.log(k));
                            
                            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
                        }
                        
                        // Initial rendering of output
                        const rawOutput = document.getElementById('rawOutput').textContent;
                        if (rawOutput) {
                            formatJsonOutput(rawOutput);
                        }
                        
                        // Toggle between raw and formatted output
                        document.getElementById('toggleRawOutput').addEventListener('change', function(e) {
                            document.getElementById('structuredOutput').style.display = e.target.checked ? 'none' : 'block';
                            document.getElementById('rawOutput').style.display = e.target.checked ? 'block' : 'none';
                        });
                        
                        function copyToClipboard() {
                            const output = document.getElementById('rawOutput');
                            const textArea = document.createElement('textarea');
                            textArea.value = output.textContent;
                            document.body.appendChild(textArea);
                            textArea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textArea);
                            
                            // Show a temporary tooltip
                            const btn = event.target.closest('button');
                            const originalText = btn.innerHTML;
                            btn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
                            setTimeout(() => {
                                btn.innerHTML = originalText;
                            }, 2000);
                        }
                    </script>
                    
                    {% if not job.log_output %}
                    <div class="alert alert-info">No output available for this job.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const jobId = "{{ job.id }}";
        const isRunning = "{{ job.status }}" === "running";
        let outputLength = "{{ job.log_output|length if job.log_output else 0 }}";
        outputLength = parseInt(outputLength, 10);
        let pollingInterval;
        
        // Setup polling for running jobs
        if (isRunning) {
            startPolling();
        }
        
        // Handle job cancellation
        const cancelButton = document.getElementById('cancelJobBtn');
        if (cancelButton) {
            cancelButton.addEventListener('click', function() {
                if (confirm('Are you sure you want to cancel this job?')) {
                    cancelJob();
                }
            });
        }
        
        // Start polling for updates
        function startPolling() {
            // Poll every second for new output
            pollingInterval = setInterval(fetchJobUpdates, 1000);
        }
        
        // Fetch job updates with incremental output
        function fetchJobUpdates() {
            fetch(`/backup/api/jobs/${jobId}?offset=${outputLength}`)
                .then(response => response.json())
                .then(data => {
                    // Update job status if changed
                    if (data.status !== 'running') {
                        clearInterval(pollingInterval);
                        // Refresh the page to get the final state
                        setTimeout(() => window.location.reload(), 1000);
                    }
                    
                    // Append new output if any
                    if (data.log_output) {
                        const outputElem = document.getElementById('rawOutput');
                        // Completely replace the content rather than append, since we're working with JSON
                        outputElem.textContent = data.log_output;
                        
                        // Format and display the JSON
                        formatJsonOutput(data.log_output);
                        
                        outputLength = data.total_output_length;
                    }
                })
                .catch(error => {
                    console.error('Error fetching job updates:', error);
                });
        }
        
        // Cancel the job
        function cancelJob() {
            fetch(`/backup/api/jobs/${jobId}/cancel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Job cancellation requested. The job will stop shortly.');
                } else {
                    alert('Failed to cancel job: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error cancelling job:', error);
                alert('Error cancelling job: ' + error);
            });
        }
    });
</script>
{% endblock %}
